/*!
 scheduler Build version 0.0.1, 09-25-2013
*/
$(function(){var a,b,c=["loading","scheduleApptSingle","singleStudent","singleTeacher","singleTimeSlot","submitForm"];if("dev"===$("body").data("env")){b=c.length;var d=function(a){$.ajax({url:"src/templates/"+a+".tpl",async:!1,success:function(b){$("#templates").append('<script type="text/template" id="'+a+'">'+b+"</script>")}})};for(a=0;b>a;a++)d(c[a])}else $.ajax({url:"dist/templates/system.tpl",async:!1,success:function(a){$("#templates").append(a)}})}),_.templateSettings={interpolate:/\{\{([\s\S]+?)\}\}/g};var ptc=new Marionette.Application;ptc.addRegions({studentRegion:"#studentRegion",teacherRegion:"#teacherRegion",timeRegion:"#timeRegion",submitRegion:"#submitRegion",scheduleRegion:"#scheduleRegion"}),ptc.on("initialize:after",function(){ptc.trigger("times:generate");var a=ptc.request("data:getinitial");$.when(a).done(function(){ptc.trigger("user:message","successfully retrieved all data"),ptc.trigger("schedule:listAppts"),ptc.trigger("reservation:new")})}),ptc.module("Config",function(a){a.Settings={exclusions:["(ASA)","(MSE)"],familyList:{webURL:"https://g.isb.bj.edu.cn/my/",listName:"FamilyInfo"},studentTeacherList:{webURL:"https://g.isb.bj.edu.cn/my/",listName:"SchedulingApplicationTeachersList"},conferenceList:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ConferenceList"},reservationLists:{HS:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ReservationsHS"},MS:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ReservationsMS"},ES:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ReservationsES"}},timeSlots:[{category:"ES",duration:20,padding:10,dates:[{startDateTime:"2013-10-21 12:00",endDateTime:"2013-10-21 20:00"},{startDateTime:"2013-10-22 08:00",endDateTime:"2013-10-22 15:30"}]},{category:"MS",duration:15,padding:0,dates:[{startDateTime:"2013-10-21 12:00",endDateTime:"2013-10-21 20:00"},{startDateTime:"2013-10-22 08:00",endDateTime:"2013-10-22 15:30"}]},{category:"HS",duration:10,padding:0,dates:[{startDateTime:"2013-10-21 12:00",endDateTime:"2013-10-21 20:00"},{startDateTime:"2013-10-22 08:00",endDateTime:"2013-10-22 15:30"}]}]}}),ptc.module("Data",function(a,b,c,d,e,f){a.Config={loggedInUser:"",students:[],teachers:[],times:[],schedule:[]},b.on("user:message",function(a){var b=e("#loading").html();e(".status-bar").append(f.template(b,{message:a}))}),b.reqres.setHandler("data:getinitial",function(){return g.getInitialData()});var g={getInitialData:function(){var c=e.Deferred(),d=b.request("user:getloggedin");return e.when(d).done(function(d){b.trigger("user:message","get logged in user"),a.Config.loggedInUser=d;var f=b.request("user:getstudents",d);e.when(f).done(function(d){b.trigger("user:message","get students"),a.Config.students=d;var f=b.request("schedule:getmy",a.Config.students[0].FamilyCode);e.when(f).done(function(c){b.trigger("user:message","get schedule"),a.Config.schedule=c});var g=b.request("student:getteachers",d);e.when(g).done(function(d){b.trigger("user:message","get teachers"),a.Config.teachers=d;var f=b.request("teacher:getconferences",d);e.when(f).done(function(d){b.trigger("user:message","get conference details"),a.Config.conferences=d;var f=b.request("teacher:gettimes",d);e.when(f).done(function(d){b.trigger("user:message","get available time slots"),a.Config.times=d,c.resolve()})})})})}),c.promise()}}}),ptc.module("Data",function(a,b,c,d,e,f){a.TimeSlots=[],b.on("times:generate",function(){g.generateTimeSlots()}),b.reqres.setHandler("user:getloggedin",function(){return g.getLoggedInUser()}),b.reqres.setHandler("user:getstudents",function(a){return g.getStudents(a)}),b.reqres.setHandler("student:getteachers",function(a){return g.getTeachers(a)}),b.reqres.setHandler("teacher:gettimes",function(a){return g.getTimes(a)}),b.reqres.setHandler("teacher:getconferences",function(a){return g.getConferences(a)}),b.reqres.setHandler("schedule:getmy",function(a){return g.getSchedule(a)}),b.on("reservation:save",function(){g.saveReservation()});var g={generateTimeSlots:function(){console.time("generate");var c,d,e,f=b.Config.Settings.timeSlots,g=f.length,h=[];for(c=0;g>c;c++){var i=f[c].dates,j=i.length;for(d=0;j>d;d++){var k=moment(i[d].startDateTime,"YYYY-MM-DD HH:mm"),l=moment(i[d].endDateTime,"YYYY-MM-DD HH:mm"),m=l.diff(k,"m",!0),n=m/f[c].duration;for(e=0;n>=e;e++){var o=(f[c].duration+f[c].padding)*e,p=moment(k).add(o,"m"),q=moment(k).add(o+f[c].duration,"m"),r=p.format("ddd D MMM h:mm"),s=p.format("X"),t=q.format("h:mm a"),u=q.format("X");h.push({category:f[c].category,startTime:r,endTime:t,unixStart:s,unixEnd:u})}}}console.timeEnd("generate"),b.trigger("user:message","generate time slots"),a.TimeSlots=h},getLoggedInUser:function(){var a=e.Deferred();return parentLogon="Kathryn.Baxter",a.resolve(parentLogon),a.promise()},getStudents:function(a){var c=e.Deferred(),d=[];return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.familyList.webURL,async:!0,listName:b.Config.Settings.familyList.listName,CAMLQuery:"<Query><Where><Eq><FieldRef Name='ParentLogonName' /><Value Type='Text'>"+a+"</Value></Eq></Where></Query>",completefunc:function(a){d=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0}),c.resolve(d)}}),c.promise()},getSchedule:function(a){var c=e.Deferred();return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.reservationLists.HS.webURL,async:!0,listName:b.Config.Settings.reservationLists.HS.listName,CAMLQuery:"<Query><Where><Eq><FieldRef Name='FamilyCode' /><Value Type='Text'>"+a+"</Value></Eq></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0}),d=[];f.each(b,function(a){a.StartTime=moment.unix(parseInt(a.StartTime)).format("ddd D MMM h:mm"),a.EndTime=moment.unix(parseInt(a.EndTime)).format("h:mm a"),d.push(a)}),c.resolve(d)}}),c.promise()},getTeachers:function(a){console.log(a);var c=e.Deferred(),d=this,g=[],h=[];return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.studentTeacherList.webURL,async:!0,listName:b.Config.Settings.studentTeacherList.listName,CAMLQuery:"<Query><Where><Eq><FieldRef Name='FamilyCode' /><Value>"+a[0].FamilyCode+"</Value></Eq></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});b&&(f.each(b,function(a){g.push({studentID:a.StudentID,teachers:a.NameValues})}),f.each(g,function(a){var b=a.teachers.split(";"),c=d.removeExcludedTeachers(b);c=f.map(c,function(a){return a.replace(/\(.+/g,"").toLowerCase()}),c=f.uniq(c),f.each(c,function(b){h.push({teacherLogon:b,studentID:a.studentID})})})),c.resolve(h)}}),c.promise()},removeExcludedTeachers:function(a){var c=a;return f.each(b.Config.Settings.exclusions,function(a){c=f.filter(c,function(b){return b.indexOf(a)<0})}),c},getConferences:function(a){var c,d=e.Deferred(),g=a,h=g.length,i=[],j="";for(c=0;h>c;c++)j+="<Value Type='Text'>ISB\\"+g[c].teacherLogon+"</Value>";return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.conferenceList.webURL,async:!0,listName:b.Config.Settings.conferenceList.listName,CAMLQuery:"<Query><Where><In><FieldRef Name='Teachers' /><Values>"+j+"</Values></In></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});f.each(b,function(a){var b=a.Teachers.split(";");b.length>2?i.push({conferenceName:a.Title,division:a.Division,roomNumber:a.Room,teacher1:b[1].split("\\")[1].toLowerCase(),teacher2:b[3].split("\\")[1].toLowerCase()}):i.push({conferenceName:a.Title,division:a.Division,roomNumber:a.Room,teacher1:b[1].split("\\")[1].toLowerCase()})}),d.resolve(i)}}),d.promise()},getTimes:function(b){var c,d,f=e.Deferred(),g=0,h=b,i=h.length,j=[],k="",l=a.TimeSlots;for(c=0;i>c;c++){for(k=h[c].teacher2?h[c].teacher1+"-"+h[c].teacher2:h[c].teacher1,d=0;d<l.length;d++)l[d].category===h[c].division&&j.push({teacherLogon:k,startTime:l[d].startTime,endTime:l[d].endTime,unixStart:l[d].unixStart,unixEnd:l[d].unixEnd});g++,g==i&&f.resolve(j)}return f.promise()},getTeacherList:function(a){var b;return b=a.teacherLogon.indexOf("-")>0?"-1;#ISB\\"+a.teacherLogon.split("-")[0]+";#-1;#ISB\\"+a.teacherLogon.split("-")[1]+";#":"-1;#ISB\\"+a.teacherLogon},setDivision:function(a){var b;return b=a.currGrade>5&&a.currGrade<9?"MS":a.currGrade>8&&a.currGrade<=12?"HS":"ES"},saveReservation:function(){var a=b.Reservation.NewReservation,c=this,d=c.getTeacherList(a),f=c.setDivision(a),g=[["Title",a.teacherName],["StudentID",a.studentID],["StudentName",a.studentName],["RoomNumber",a.roomNumber],["StartTime",a.startTime],["EndTime",a.endTime],["FamilyCode",a.familyCode],["Teachers",d]];e().SPServices({operation:"UpdateListItems",async:!1,webURL:b.Config.Settings.reservationLists[f].webURL,batchCmd:"New",listName:b.Config.Settings.reservationLists[f].listName,valuepairs:g,completefunc:function(a){console.log(a),b.trigger("user:message","successfully reserved")}})},deleteReservation:function(){}}}),ptc.module("Reservation",function(a,b){a.NewReservation={studentID:"",studentName:"",teacherName:"",teacherLogon:"",startTime:"",endTime:"",familyCode:"",currGrade:"",roomNumber:""},b.on("reservation:new",function(){c.newReservation()}),b.on("reservation:create",function(){c.createReservation()}),b.on("students:list",function(){c.listStudents()}),b.on("teachers:list",function(a){c.listTeachers(a)}),b.on("times:list",function(a){c.listTimes(a)}),b.on("submit:enable",function(){c.enableSubmit()});var c={listStudents:function(){b.teacherRegion.close(),b.timeRegion.close(),b.submitRegion.close(),a.Controller.listStudents()},listTeachers:function(c){b.timeRegion.close(),b.submitRegion.close(),a.Controller.listTeachers(c)},listTimes:function(c){b.submitRegion.close(),a.Controller.listTimes(c)},newReservation:function(){a.Controller.startNewReservation()},createReservation:function(){a.Controller.createReservation()},enableSubmit:function(){a.Controller.enableSubmit()}}}),ptc.module("Reservation",function(a,b,c,d,e,f){a.Controller={startNewReservation:function(){b.trigger("students:list")},createReservation:function(){var b=new a.Appt(a.NewReservation);console.log(b)},listStudents:function(){var c=new a.StudentCollection(b.Data.Config.students),d=new a.Views.StudentList({collection:c});a.NewReservation.familyCode=b.Data.Config.students[0].FamilyCode,d.on("show",function(){this.$el.before("Select a student: ")}),b.studentRegion.show(d)},listTeachers:function(c){var d=this.customizeTeacherList(c),e=new a.TeacherCollection(d),f=new a.Views.TeacherList({collection:e});f.on("show",function(){this.$el.before("Select a teacher: ")}),b.teacherRegion.show(f)},customizeTeacherList:function(a){var c,d=f.pluck(f.where(b.Data.Config.teachers,{studentID:String(a)}),"teacherLogon"),e=[];for(c=0;c<d.length;c++){f.findWhere(b.Data.Config.conferences,{teacher2:d[c]});var g=f.findWhere(b.Data.Config.conferences,{teacher1:d[c]});g&&e.push(g)}return e},listTimes:function(c){var d=b.Data.Config.times,e=f.where(d,{teacherLogon:c}),g=new a.TimeCollection(e),h=new a.Views.TimeList({collection:g});h.on("show",function(){this.$el.before("Select a time slot: ")}),b.timeRegion.show(h)},enableSubmit:function(){var c=new a.Views.SubmitView;b.submitRegion.show(c)}}}),ptc.module("Reservation",function(a,b,c){a.Appt=c.Model.extend({defaults:{studentID:"",studentName:"",teacherName:"",teacherLogon:"",startTime:"",endTime:"",familyCode:""}}),a.ApptCollection=c.Collection.extend({model:a.Appt}),a.Student=c.Model.extend({defaults:{fullName:"",studentID:"",familyCode:""}}),a.StudentCollection=c.Collection.extend({model:a.Student}),a.Teacher=c.Model.extend({defaults:{fullName:"",studentID:"",familyCode:""}}),a.TeacherCollection=c.Collection.extend({model:a.Teacher}),a.Time=c.Model.extend({defaults:{startTime:"",endTime:""}}),a.TimeCollection=c.Collection.extend({model:a.Time})}),ptc.module("Reservation.Views",function(a,b,c,d,e){a.Layout=d.Layout.extend({template:"#reservationLayout",regions:{studentRegion:"#resStudents",teacherRegion:"#resTeachers",timeRegion:"#resTimes"}}),a.SubmitView=d.ItemView.extend({template:"#submitForm",events:{"click .js-submit-form":"submitFormClicked"},submitFormClicked:function(a){a.preventDefault(),b.trigger("reservation:create")}}),a.StudentItem=d.ItemView.extend({tagName:"option",className:"student",template:"#singleStudent",onRender:function(){e(this.el).attr("data-studentid",this.model.get("StudentID")).attr("data-currgrade",this.model.get("CurrentGrade")).attr("data-fullname",this.model.get("StudentFullName"))}}),a.StudentList=d.CollectionView.extend({tagName:"select",className:"student-list",itemView:a.StudentItem,onRender:function(){this.$el.prepend("<option></option>")},events:{change:"optionSelected"},optionSelected:function(a){if(a.target.value&&0!=a.target.value){var c=e(a.target).find(":selected").data("studentid"),d=e(a.target).find(":selected").data("fullname"),f=e(a.target).find(":selected").data("currgrade");b.Reservation.NewReservation.currGrade=f,b.Reservation.NewReservation.studentID=c,b.Reservation.NewReservation.studentName=d,b.trigger("teachers:list",c)}else console.log("no name selected"),b.teacherRegion.close(),b.timeRegion.close(),b.submitRegion.close()}}),a.TeacherItem=d.ItemView.extend({tagName:"option",className:"teacher",template:"#singleTeacher",onRender:function(){if(this.model.get("teacher2")){var a=this.model.get("teacher1")+"-"+this.model.get("teacher2");e(this.el).attr("data-teacherlogon",a)}else e(this.el).attr("data-teacherlogon",this.model.get("teacher1"));e(this.el).attr("data-roomNumber",this.model.get("roomNumber"))}}),a.TeacherList=d.CollectionView.extend({tagName:"select",className:"teacher-list",itemView:a.TeacherItem,onRender:function(){this.$el.prepend("<option></option>")},events:{change:"optionSelected"},optionSelected:function(a){if(a.target.value&&0!=a.target.value){var c=e(a.target).find(":selected").data("teacherlogon"),d=e(a.target).find(":selected").data("roomnumber"),f=e(a.target).find(":selected").val();b.Reservation.NewReservation.teacherName=f,b.Reservation.NewReservation.teacherLogon=c,b.Reservation.NewReservation.roomNumber=d,b.trigger("times:list",c)}else console.log("no name selected"),b.timeRegion.close(),b.submitRegion.close()}}),a.TimeItem=d.ItemView.extend({tagName:"option",className:"time",template:"#singleTimeSlot",onRender:function(){e(this.el).attr("data-start",this.model.get("unixStart")).attr("data-end",this.model.get("unixEnd"))}}),a.TimeList=d.CollectionView.extend({tagName:"select",className:"time-list",itemView:a.TimeItem,onRender:function(){this.$el.prepend("<option></option>")},events:{change:"optionSelected"},optionSelected:function(a){if(a.target.value&&0!=a.target.value){var c=e(a.target).find(":selected").data("start"),d=e(a.target).find(":selected").data("end");b.Reservation.NewReservation.startTime=c,b.Reservation.NewReservation.endTime=d,b.trigger("submit:enable")}else console.log("no name selected"),b.submitRegion.close()}})}),ptc.module("Schedule",function(a,b){b.on("schedule:listAppts",function(){c.showSchedule()}),b.on("schedule:appt:delete",function(a){c.deleteAppt(a)});var c={showSchedule:function(){a.Controller.showSchedule()},deleteAppt:function(b){a.Controller.deleteAppt(b)}}}),ptc.module("Schedule",function(a,b){a.Controller={showSchedule:function(){var c=new a.ApptCollection(b.Data.Config.schedule),d=new a.View.ApptList({collection:c});b.scheduleRegion.show(d)},deleteAppt:function(a){var c=a.get("ID");$().SPServices({operation:"UpdateListItems",async:!0,webURL:b.Config.Settings.reservationLists.HS.webURL,listName:b.Config.Settings.reservationLists.HS.listName,batchCmd:"Delete",ID:c,completefunc:function(){b.trigger("user:message","reservation deleted")}})}}}),ptc.module("Schedule",function(a,b,c){a.Appt=c.Model.extend({defaults:{studentName:"",teacher:"",time:"",room:""}}),a.ApptCollection=c.Collection.extend({model:a.Appt})}),ptc.module("Schedule.View",function(a,b,c,d){a.ApptItem=d.ItemView.extend({tagName:"li",className:"appt",template:"#scheduleApptSingle",events:{"click a.js-delete-appt":"deleteClicked"},deleteClicked:function(a){a.preventDefault(),b.trigger("schedule:appt:delete",this.model),this.remove()}}),a.ApptList=d.CollectionView.extend({tagName:"ul",className:"appt-schedule",itemView:a.ApptItem})}),$(function(){ptc.start()});