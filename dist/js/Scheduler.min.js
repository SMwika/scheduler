/*!
 scheduler Build version 0.0.1, 10-05-2013
*/
$(function(){var a,b,c=["loading","scheduleApptSingle","singleStudent","singleTeacher","singleTimeSlot","studentListContainer","teacherListContainer","timeListContainer","submitChecking","submitUnavailable","submitDoubleBooked","submitSuccess","submitError","submitForm"];if("dev"===$("body").data("env")){b=c.length;var d=function(a){$.ajax({url:"src/templates/"+a+".tpl",async:!1,success:function(b){$("#templates").append('<script type="text/template" id="'+a+'">'+b+"</script>")}})};for(a=0;b>a;a++)d(c[a])}else $.ajax({url:"dist/templates/system.tpl",async:!1,success:function(a){$("#templates").append(a)}})}),_.templateSettings={interpolate:/\{\{([\s\S]+?)\}\}/g},Marionette.Region.prototype.open=function(a){this.$el.hide(),this.$el.html(a.el),this.$el.slideDown("medium")},Object.prototype.hasOwnProperty=function(a){return void 0!==this[a]};var ptc=new Marionette.Application;ptc.addRegions({studentRegion:"#studentRegion",teacherRegion:"#teacherRegion",timeRegion:"#timeRegion",submitRegion:"#submitRegion",scheduleRegion:"#scheduleRegion"}),ptc.on("initialize:after",function(){ptc.trigger("times:generate");var a=ptc.request("data:getinitial");$.when(a).done(function(){ptc.trigger("user:message","successfully retrieved all data"),ptc.trigger("schedule:listAppts"),ptc.trigger("reservation:new")})}),ptc.module("Config",function(a){a.Settings={overrides:{exclusions:["(ASA)","(MSE)","hanichowski(Homeroom)","mskinner(Homeroom)","fpanych(Homeroom)","scoe(Homeroom)","ehillmann(Homeroom)","GRussell(Homeroom)","bjogi(Homeroom)","jbinns(Homeroom)","breverman(Homeroom)","boreilly(Homeroom)","jkinsella(Homeroom)","DMonroe(Homeroom)","jmcroberts(Homeroom)","drussell(Homeroom)","mdawson(Homeroom)","gloynes(Homeroom)"],inclusions:["aflores"]},familyList:{webURL:"https://g.isb.bj.edu.cn/my/",listName:"FamilyInfo"},studentTeacherList:{webURL:"https://g.isb.bj.edu.cn/my/",listName:"SchedulingApplicationTeachersList"},conferenceList:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ConferenceList"},reservationLists:{HS:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ReservationsHS"},MS:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ReservationsMS"},ES:{webURL:"https://g.isb.bj.edu.cn/test/conferencing/",listName:"ReservationsES"}},timeSlots:[{category:"ES",duration:20,padding:10,dates:[{startDateTime:"2013-10-21 12:00",endDateTime:"2013-10-21 19:30"},{startDateTime:"2013-10-22 08:00",endDateTime:"2013-10-22 15:00"}]},{category:"MS",duration:15,padding:0,dates:[{startDateTime:"2013-10-21 12:00",endDateTime:"2013-10-21 19:45"},{startDateTime:"2013-10-22 08:00",endDateTime:"2013-10-22 15:15"}]},{category:"HS",duration:10,padding:0,dates:[{startDateTime:"2013-10-21 12:00",endDateTime:"2013-10-21 19:50"},{startDateTime:"2013-10-22 08:00",endDateTime:"2013-10-22 15:20"}]}]}}),ptc.module("Data",function(a,b,c,d,e,f){a.Config={loggedInUser:"",students:[],teachers:[],times:[],schedule:[]},b.on("user:message",function(a){var b=e("#loading").html();e(".status-bar").append(f.template(b,{message:a}))}),b.reqres.setHandler("data:getinitial",function(){return g.getInitialData()});var g={getInitialData:function(){var c=e.Deferred(),d=b.request("user:getloggedin");return e.when(d).done(function(d){b.trigger("user:message","get logged in user"),a.Config.loggedInUser=d;var g=b.request("teacher:getconf",d);e.when(g).done(function(g){if(b.trigger("user:message","check role and get conferences"),g){a.Config.conferences=g,a.Config.userRole="teacher",b.Reservation.NewReservation.roomNumber=g[0].roomNumber,b.Reservation.NewReservation.teacherName=g[0].conferenceName,b.Reservation.NewReservation.teacherLogon=g[0].hasOwnProperty("teacher2")?g[0].teacher1+"-"+g[0].teacher2:g[0].teacher1,b.Reservation.NewReservation.division=g[0].division,b.Reservation.NewReservation.studentName="-",b.Reservation.NewReservation.reserver=a.Config.loggedInUser;var h=b.request("teacher:getmyteacherschedule",g[0]);e.when(h).done(function(c){b.trigger("user:message","get schedule"),a.Config.schedule=c});var i=b.request("teacher:getschedule",g);e.when(i).done(function(d){b.trigger("user:message","got teacher reservations"),a.Config.teacherSchedules=d;var f=b.request("teacher:gettimes",g);e.when(f).done(function(d){b.trigger("user:message","get available time slots"),a.Config.times=d;var f=b.request("times:getavailable");e.when(f).done(function(d){a.Config.newTimes=d,b.trigger("user:message","filtered the times"),c.resolve()})})})}else{a.Config.userRole="parent";var j=b.request("user:getstudents",d);e.when(j).done(function(d){b.trigger("user:message","get students"),a.Config.students=d;var g=b.request("schedule:getmy",a.Config.students[0].FamilyCode);e.when(g).done(function(c){b.trigger("user:message","get schedule"),a.Config.schedule=c});var h=b.request("student:getteachers",d);e.when(h).done(function(d){b.trigger("user:message","get teachers"),a.Config.teachers=d;var g=[];f.each(d,function(a){g.push(a.teacherLogon)});var h=b.request("teacher:getconferences",g);e.when(h).done(function(d){b.trigger("user:message","get conference details"),a.Config.conferences=d;var f=b.request("teacher:getschedule",d);e.when(f).done(function(f){b.trigger("user:message","got teacher reservations"),a.Config.teacherSchedules=f;var g=b.request("teacher:gettimes",d);e.when(g).done(function(d){b.trigger("user:message","get available time slots"),a.Config.times=d;var f=b.request("times:getavailable");e.when(f).done(function(d){a.Config.newTimes=d,b.trigger("user:message","filtered the times"),c.resolve()})})})})})})}})}),c.promise()}}}),ptc.module("Data",function(a,b,c,d,e,f){a.TimeSlots=[],b.on("times:generate",function(){g.generateTimeSlots()}),b.reqres.setHandler("user:getloggedin",function(){return g.getLoggedInUser()}),b.reqres.setHandler("user:getstudents",function(a){return g.getStudents(a)}),b.reqres.setHandler("student:getteachers",function(a){return g.getTeachers(a)}),b.reqres.setHandler("teacher:gettimes",function(a){return g.getTimes(a)}),b.reqres.setHandler("teacher:getschedule",function(a){return g.getTeacherSchedule(a)}),b.reqres.setHandler("teacher:getconf",function(a){return g.getTeacherConf(a)}),b.reqres.setHandler("teacher:getconferences",function(a){return g.getConferences(a)}),b.reqres.setHandler("teacher:getmyteacherschedule",function(a){return g.getMyTeacherSchedule(a)}),b.reqres.setHandler("schedule:getmy",function(a){return g.getSchedule(a)}),b.reqres.setHandler("data:getTeacherAvailability",function(a){return g.getTeacherAvailability(a)}),b.reqres.setHandler("data:getStudentTeacherStatus",function(a){return g.getStudentTeacherStatus(a)}),b.reqres.setHandler("times:getavailable",function(){return g.getAvailableTimes()}),b.on("data:reservation:save",function(){g.saveReservation()}),b.on("data:reservation:delete",function(a){g.deleteReservation(a)});var g={generateTimeSlots:function(){var c,d,e,f=b.Config.Settings.timeSlots,g=f.length,h=[];for(c=0;g>c;c++){var i=f[c].dates,j=i.length;for(d=0;j>d;d++){var k=moment(i[d].startDateTime,"YYYY-MM-DD HH:mm"),l=moment(i[d].endDateTime,"YYYY-MM-DD HH:mm"),m=l.diff(k,"m",!0),n=m/f[c].duration;for(e=0;n>=e;e++){var o=(f[c].duration+f[c].padding)*e,p=moment(k).add(o,"m"),q=moment(k).add(o+f[c].duration,"m"),r=p.format("ddd D MMM h:mm"),s=p.format("X"),t=q.format("h:mm a"),u=q.format("X");h.push({category:f[c].category,startTime:r,endTime:t,unixStart:s,unixEnd:u})}}}b.trigger("user:message","generate time slots"),a.TimeSlots=h},getLoggedInUser:function(){var a=e.Deferred(),b=e().SPServices.SPGetCurrentUser({fieldName:"Name",debug:!1,async:!0});return b=b.split("\\")[1],a.resolve(b),a.promise()},getStudents:function(a){var c=e.Deferred(),d=[];return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.familyList.webURL,async:!0,listName:b.Config.Settings.familyList.listName,CAMLQuery:"<Query><Where><Eq><FieldRef Name='ParentLogonName' /><Value Type='Text'>"+a+"</Value></Eq></Where></Query>",completefunc:function(a){d=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0}),c.resolve(d)}}),c.promise()},getSchedule:function(a){var c=e.Deferred(),d=this,g=[],h=0,i=f.keys(b.Config.Settings.reservationLists);return f.each(i,function(i){e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.reservationLists[i].webURL,async:!0,listName:b.Config.Settings.reservationLists[i].listName,CAMLQuery:"<Query><Where><Eq><FieldRef Name='FamilyCode' /><Value Type='Text'>"+a+"</Value></Eq></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});f.each(b,function(a){var b=d.formatScheduleDates(a);b.Division=i,g.push(b)}),h++,3===h&&c.resolve(g)}})}),c.promise()},formatScheduleDates:function(a){return a.StartTime=moment.unix(parseInt(a.StartTime,10)).format("ddd D MMM h:mm"),a.EndTime=moment.unix(parseInt(a.EndTime,10)).format("h:mm a"),a},getTeachers:function(a){var c=e.Deferred(),d=this,g=[],h=[];return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.studentTeacherList.webURL,async:!0,listName:b.Config.Settings.studentTeacherList.listName,CAMLQuery:"<Query><Where><Eq><FieldRef Name='FamilyCode' /><Value>"+a[0].FamilyCode+"</Value></Eq></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});b&&(f.each(b,function(a){g.push({studentID:a.StudentID,teachers:a.NameValues.toLowerCase()})}),f.each(g,function(a){var b=a.teachers.split(";"),c=d.processOverrides(b);c=f.map(c,function(a){return a.replace(/\(.+/g,"")}),c=f.uniq(c),f.each(c,function(b){h.push({teacherLogon:b,studentID:a.studentID})})})),c.resolve(h)}}),c.promise()},processOverrides:function(a){var c=[],d=[];return f.each(b.Config.Settings.overrides.exclusions,function(b){b=b.toLowerCase();var d=f.filter(a,function(a){return a.indexOf(b)>=0});c=c.concat(d)}),f.each(b.Config.Settings.overrides.inclusions,function(a){a=a.toLowerCase();var b=f.filter(c,function(b){return-1===b.indexOf(a)});d=d.concat(b)}),f.each(d,function(b){a=f.filter(a,function(a){return-1===a.indexOf(b)})}),a},getConferences:function(a){var c,d=e.Deferred(),f=this,g=a,h=g.length,i="";for(c=0;h>c;c++)i+="<Value Type='Text'>ISB\\"+g[c]+"</Value>";return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.conferenceList.webURL,async:!0,listName:b.Config.Settings.conferenceList.listName,CAMLQuery:"<Query><Where><In><FieldRef Name='Teachers' /><Values>"+i+"</Values></In></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0}),c=f.niceifyConferences(b);d.resolve(c)}}),d.promise()},niceifyConferences:function(a){var b=[];return f.each(a,function(a){var c=a.Teachers.split(";");c.length>2?b.push({conferenceName:a.Title,division:a.Division,roomNumber:a.Room,teacher1:c[1].split("\\")[1].toLowerCase(),teacher2:c[3].split("\\")[1].toLowerCase()}):b.push({conferenceName:a.Title,division:a.Division,roomNumber:a.Room,teacher1:c[1].split("\\")[1].toLowerCase()})}),b},getTimes:function(b){var c,d,f=e.Deferred(),g=0,h=b,i=h.length,j=[],k="",l=a.TimeSlots;for(c=0;i>c;c++){for(k=h[c].teacher2?h[c].teacher1+"-"+h[c].teacher2:h[c].teacher1,d=0;d<l.length;d++)l[d].category===h[c].division&&j.push({teacherLogon:k,startTime:l[d].startTime,endTime:l[d].endTime,unixStart:l[d].unixStart,unixEnd:l[d].unixEnd});g++,g==i&&f.resolve(j)}return f.promise()},getAvailableTimes:function(){var a=e.Deferred(),c=b.Data.Config.times,d=b.Data.Config.teacherSchedules,g=[],h=[];return f.each(d,function(a){var b=a.Teachers.split(";"),c="";c=b.length>2?b[1].split("\\")[1]+"-"+b[3].split("\\")[1]:b[1].split("\\")[1],c=c.toLowerCase(),g.push({teacherLogon:c,unixStart:a.StartTime})}),h=f.reject(c,function(a){var b=!1;return f.each(g,function(c){var d=c.unixStart===a.unixStart,e=c.teacherLogon===a.teacherLogon;d&&e&&(b=!0)}),b}),a.resolve(h),a.promise()},getTeacherConf:function(a){var c=e.Deferred(),d=this;return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.conferenceList.webURL,async:!0,listName:b.Config.Settings.conferenceList.listName,CAMLRowLimit:1,CAMLQuery:"<Query><Where><In><FieldRef Name='Teachers' /><Values><Value Type='Text'>ISB\\"+a+"</Value></Values></In></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});if(b.length>0){var f=d.niceifyConferences(b);c.resolve(f)}else c.resolve(!1)}}),c.promise()},getMyTeacherSchedule:function(c){var d=e.Deferred(),g=this,h=[];return e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.reservationLists[c.division].webURL,async:!0,listName:b.Config.Settings.reservationLists[c.division].listName,CAMLQuery:"<Query><Where><In><FieldRef Name='Teachers' /><Values><Value Type='Text'>ISB\\"+a.Config.loggedInUser+"</Value></Values></In></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});b.length>0?(f.each(b,function(a){var b=g.formatScheduleDates(a);b.Division=c.division,h.push(b)}),d.resolve(h)):d.resolve(!1)}}),d.promise()},getTeacherSchedule:function(a){var c=e.Deferred(),d=0,g=[];return f.each(a,function(f){e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.reservationLists[f.division].webURL,async:!0,listName:b.Config.Settings.reservationLists[f.division].listName,CAMLQuery:"<Query><Where><In><FieldRef Name='Teachers' /><Values><Value Type='Text'>ISB\\"+f.teacher1+"</Value></Values></In></Where></Query>",completefunc:function(b){var f=e(b.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});f.length>0&&(g=g.concat(f)),d++,d===a.length&&c.resolve(g)}})}),c.promise()},getTeacherList:function(a){var b;return b=a.teacherLogon.indexOf("-")>0?"-1;#ISB\\"+a.teacherLogon.split("-")[0]+";#-1;#ISB\\"+a.teacherLogon.split("-")[1]+";#":"-1;#ISB\\"+a.teacherLogon},setDivision:function(a){var b;return b=a.currGrade>5&&a.currGrade<9?"MS":a.currGrade>8&&a.currGrade<=12?"HS":"ES"},saveReservation:function(){var a=b.Reservation.NewReservation,c=this,d=c.getTeacherList(a),f=[["Title",a.teacherName],["StudentID",a.studentID],["StudentName",a.studentName],["RoomNumber",a.roomNumber],["StartTime",a.startTime],["EndTime",a.endTime],["FamilyCode",a.familyCode],["Reserver",a.reserver],["Teachers",d]];e().SPServices({operation:"UpdateListItems",async:!1,webURL:b.Config.Settings.reservationLists[a.division].webURL,batchCmd:"New",listName:b.Config.Settings.reservationLists[a.division].listName,valuepairs:f,completefunc:function(d){if("OK"==d.statusText){var f=e(d.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0}),g=c.formatScheduleDates(f[0]);g.Division=a.division,b.Reservation.ReservingStatus=!1,b.trigger("submit:options","success"),b.trigger("schedule:append",g),b.trigger("user:message","successfully reserved")}else b.trigger("submit:options","error"),b.trigger("user:message","error saving your reservation")}})},getTeacherAvailability:function(a){var c=a.teacherLogon,d=a.startTime;c.indexOf("-")>0&&(c=c.split("-")[0]);var g=e.Deferred(),h=!0,i=0,j=f.keys(b.Config.Settings.reservationLists);return f.each(j,function(a){e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.reservationLists[a].webURL,async:!0,listName:b.Config.Settings.reservationLists[a].listName,CAMLQuery:"<Query><Where><And><In><FieldRef Name='Teachers' /><Values><Value Type='Text'>ISB\\"+c+"</Value></Values></In><Eq><FieldRef Name='StartTime' /><Value Type='Text'>"+d+"</Value></Eq></And></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});b.length>0&&(h=!1,g.resolve(h)),i++,i===j.length&&g.resolve(h)}})}),g.promise()},getStudentTeacherStatus:function(a){var c=a.teacherLogon,d=a.studentID;c.indexOf("-")>0&&(c=c.split("-")[0]);var g=e.Deferred(),h=!0,i=0,j=f.keys(b.Config.Settings.reservationLists);return f.each(j,function(a){e().SPServices({operation:"GetListItems",webURL:b.Config.Settings.reservationLists[a].webURL,async:!0,listName:b.Config.Settings.reservationLists[a].listName,CAMLQuery:"<Query><Where><And><In><FieldRef Name='Teachers' /><Values><Value Type='Text'>ISB\\"+c+"</Value></Values></In><Eq><FieldRef Name='StudentID' /><Value Type='Text'>"+d+"</Value></Eq></And></Where></Query>",completefunc:function(a){var b=e(a.responseXML).SPFilterNode("z:row").SPXmlToJson({includeAllAttrs:!0,removeOws:!0});b.length>0&&(h=!1,g.resolve(h)),i++,i===j.length&&g.resolve(h)}})}),g.promise()},deleteReservation:function(a){var c=a.get("ID"),d=a.get("Division");e().SPServices({operation:"UpdateListItems",async:!0,webURL:b.Config.Settings.reservationLists[d].webURL,listName:b.Config.Settings.reservationLists[d].listName,batchCmd:"Delete",ID:c,completefunc:function(){b.trigger("user:message","reservation deleted")}})}}}),ptc.module("Reservation",function(a,b){a.ReservingStatus=!1,a.NewReservation={studentID:"",studentName:"",teacherName:"",teacherLogon:"",startTime:"",endTime:"",familyCode:"",currGrade:"",roomNumber:""},b.on("reservation:new",function(){c.newReservation()}),b.on("reservation:create",function(){c.createReservation()}),b.on("students:list",function(){c.listStudents()}),b.on("teachers:list",function(a){c.listTeachers(a)}),b.on("times:list",function(a){c.listTimes(a)}),b.on("submit:options",function(a){c.enableSubmit(a)}),b.reqres.setHandler("reservation:availability",function(a){return c.checkAvailability(a)});var c={listStudents:function(){b.teacherRegion.close(),b.timeRegion.close(),b.submitRegion.close(),a.Controller.listStudents()},listTeachers:function(c){b.timeRegion.close(),b.submitRegion.close(),a.Controller.listTeachers(c)},listTimes:function(c){b.submitRegion.close(),a.Controller.listTimes(c)},newReservation:function(){a.Controller.startNewReservation()},createReservation:function(){a.ReservingStatus=!0;var c=b.request("reservation:availability",a.NewReservation);$.when(c).done(function(b){b===!0?a.Controller.createReservation():a.ReservingStatus=!1})},checkAvailability:function(a){var c=$.Deferred(),d=!1,e=b.request("data:getTeacherAvailability",a);return $.when(e).done(function(e){if(e===!0){var f=b.request("data:getStudentTeacherStatus",a);$.when(f).done(function(a){a===!0?(d=!0,c.resolve(d)):(d=!1,b.trigger("submit:options","unavailable"),c.resolve(d))})}else b.trigger("submit:options","doublebooked"),c.resolve(d)}),c.promise()},enableSubmit:function(b){a.Controller.enableSubmit(b)}}}),ptc.module("Reservation",function(a,b,c,d,e,f){a.Controller={startNewReservation:function(){"parent"===b.Data.Config.userRole?b.trigger("students:list"):"teacher"===b.Data.Config.userRole&&b.trigger("times:list",b.Data.Config.loggedInUser)},createReservation:function(){b.trigger("data:reservation:save")},listStudents:function(){var c=new a.StudentCollection(b.Data.Config.students),d=new a.Views.StudentList({collection:c});a.NewReservation.familyCode=b.Data.Config.students[0].FamilyCode,b.studentRegion.show(d)},listTeachers:function(c){var d=this.customizeTeacherList(c),e=new a.TeacherCollection(d),f=new a.Views.TeacherList({collection:e});b.teacherRegion.show(f)},customizeTeacherList:function(a){var c,d=f.pluck(f.where(b.Data.Config.teachers,{studentID:String(a)}),"teacherLogon"),e=[];for(c=0;c<d.length;c++){var g=f.findWhere(b.Data.Config.conferences,{teacher1:d[c]});g&&e.push(g)}return e},listTimes:function(c){var d=b.Data.Config.newTimes,e=f.where(d,{teacherLogon:c.toLowerCase()}),g=new a.TimeCollection(e),h=new a.Views.TimeList({collection:g});b.timeRegion.show(h)},enableSubmit:function(c){var d;switch(c){case"submit":d=new a.Views.SubmitView;break;case"checking":d=new a.Views.SubmitChecking;break;case"unavailable":d=new a.Views.SubmitUnavailable;break;case"doublebooked":d=new a.Views.SubmitDoubleBooked;break;case"success":d=new a.Views.SubmitSuccess;break;case"error":d=new a.Views.SubmitError}b.submitRegion.show(d)}}}),ptc.module("Reservation",function(a,b,c){a.Appt=c.Model.extend({defaults:{studentID:"",studentName:"",teacherName:"",teacherLogon:"",startTime:"",endTime:"",familyCode:""}}),a.ApptCollection=c.Collection.extend({model:a.Appt}),a.Student=c.Model.extend({defaults:{fullName:"",studentID:"",familyCode:""}}),a.StudentCollection=c.Collection.extend({model:a.Student}),a.Teacher=c.Model.extend({defaults:{fullName:"",studentID:"",familyCode:""}}),a.TeacherCollection=c.Collection.extend({model:a.Teacher}),a.Time=c.Model.extend({defaults:{startTime:"",endTime:""}}),a.TimeCollection=c.Collection.extend({model:a.Time})}),ptc.module("Reservation.Views",function(a,b,c,d,e){a.Layout=d.Layout.extend({template:"#reservationLayout",regions:{studentRegion:"#resStudents",teacherRegion:"#resTeachers",timeRegion:"#resTimes"}}),a.SubmitView=d.ItemView.extend({template:"#submitForm",events:{"click .js-submit-form":"submitFormClicked"},submitFormClicked:function(a){a.preventDefault(),b.Reservation.ReservingStatus===!1?(b.trigger("reservation:create"),b.trigger("submit:options","checking")):b.trigger("submit:options","checking")}}),a.SubmitChecking=d.ItemView.extend({template:"#submitChecking",className:"status-res"}),a.SubmitUnavailable=d.ItemView.extend({template:"#submitUnavailable",className:"status-res"}),a.SubmitDoubleBooked=d.ItemView.extend({template:"#submitDoubleBooked",className:"status-res",initialize:function(){"parent"===b.Data.Config.userRole&&b.timeRegion.close()}}),a.SubmitSuccess=d.ItemView.extend({template:"#submitSuccess",className:"status-res",initialize:function(){"parent"===b.Data.Config.userRole&&(b.teacherRegion.close(),b.timeRegion.close())}}),a.StudentItem=d.ItemView.extend({tagName:"option",className:"student",template:"#singleStudent",onRender:function(){e(this.el).attr("data-studentid",this.model.get("StudentID")).attr("data-currgrade",this.model.get("CurrentGrade")).attr("data-fullname",this.model.get("StudentFullName"))}}),a.StudentList=d.CompositeView.extend({itemViewContainer:".student-selector",template:"#studentListContainer",className:"student-list",itemView:a.StudentItem,events:{"click button":"optionSelected","click select":"closeStuff"},optionSelected:function(a){a.preventDefault();var c=e(a.currentTarget).siblings(".student-selector");if(c.val()&&0!=c.val()){var d=e(c).find(":selected").data("studentid"),f=e(c).find(":selected").data("fullname"),g=e(c).find(":selected").data("currgrade");b.Reservation.NewReservation.reserver=b.Data.Config.loggedInUser,b.Reservation.NewReservation.currGrade=g,b.Reservation.NewReservation.studentID=d,b.Reservation.NewReservation.studentName=f,b.trigger("teachers:list",d)}else this.closeStuff()},closeStuff:function(){b.teacherRegion.close(),b.timeRegion.close(),b.submitRegion.close()}}),a.TeacherItem=d.ItemView.extend({tagName:"option",className:"teacher",template:"#singleTeacher",onRender:function(){if(this.model.get("teacher2")){var a=this.model.get("teacher1")+"-"+this.model.get("teacher2");e(this.el).attr("data-teacherlogon",a)}else e(this.el).attr("data-teacherlogon",this.model.get("teacher1"));e(this.el).attr("data-roomnumber",this.model.get("roomNumber")),e(this.el).attr("data-division",this.model.get("division"))}}),a.TeacherList=d.CompositeView.extend({itemViewContainer:".teacher-selector",template:"#teacherListContainer",className:"teacher-list",itemView:a.TeacherItem,events:{"click button":"optionSelected","click select":"closeStuff"},optionSelected:function(a){a.preventDefault();var c=e(a.currentTarget).siblings(".teacher-selector");if(c.val()&&0!=c.val()){var d=e(c).find(":selected").data("teacherlogon"),f=e(c).find(":selected").data("roomnumber"),g=e(c).find(":selected").data("division"),h=e(c).find(":selected").val();b.Reservation.NewReservation.teacherName=h,b.Reservation.NewReservation.teacherLogon=d,b.Reservation.NewReservation.roomNumber=f,b.Reservation.NewReservation.division=g,b.trigger("times:list",d)}else this.closeStuff()},closeStuff:function(){b.timeRegion.close(),b.submitRegion.close()}}),a.TimeItem=d.ItemView.extend({tagName:"option",className:"time",template:"#singleTimeSlot",onRender:function(){e(this.el).attr("data-start",this.model.get("unixStart")).attr("data-end",this.model.get("unixEnd"))}}),a.TimeList=d.CompositeView.extend({itemViewContainer:".time-selector",template:"#timeListContainer",className:"time-list",itemView:a.TimeItem,events:{"click button":"optionSelected","click select":"closeStuff"},optionSelected:function(a){a.preventDefault();var c=e(a.currentTarget).siblings(".time-selector");if(c.val()&&0!=c.val()){var d=e(c).find(":selected").data("start"),f=e(c).find(":selected").data("end");b.Reservation.NewReservation.startTime=d,b.Reservation.NewReservation.endTime=f,b.trigger("submit:options","submit")}else this.closeStuff()},closeStuff:function(){b.submitRegion.close()}})}),ptc.module("Schedule",function(a,b){b.on("schedule:listAppts",function(){c.showSchedule()}),b.on("schedule:appt:delete",function(a){c.deleteAppt(a)}),b.on("schedule:append",function(a){c.appendAppt(a)});var c={showSchedule:function(){a.Controller.showSchedule()},deleteAppt:function(b){a.Controller.deleteAppt(b)},appendAppt:function(c){var d=new a.Appt(c);b.trigger("schedule:collection:add",d)}}}),ptc.module("Schedule",function(a,b){a.Controller={showSchedule:function(){var c=new a.ApptCollection(b.Data.Config.schedule),d=new a.View.ApptList({collection:c});b.on("schedule:collection:add",function(a){c.add(a)}),b.scheduleRegion.show(d)},deleteAppt:function(a){b.trigger("data:reservation:delete",a)}}}),ptc.module("Schedule",function(a,b,c){a.Appt=c.Model.extend({defaults:{studentName:"",teacher:"",time:"",room:""}}),a.ApptCollection=c.Collection.extend({model:a.Appt,comparator:function(a){return a.get("StartTime")}})}),ptc.module("Schedule.View",function(a,b,c,d){a.ApptItem=d.ItemView.extend({tagName:"li",className:"appt",template:"#scheduleApptSingle",events:{"click a.js-delete-appt":"deleteClicked"},deleteClicked:function(a){a.preventDefault(),this.model.get("Reserver")===b.Data.Config.loggedInUser?(b.trigger("schedule:appt:delete",this.model),this.remove()):alert("Sorry, you cannot delete reservations you did not create")}}),a.ApptList=d.CollectionView.extend({tagName:"ul",className:"appt-schedule",itemView:a.ApptItem,onRender:function(){this.$el.fadeIn()},appendHtml:function(a,b,c){var d=$(a.childrenContainer||a.el),e=d.children();e.size()===c?d.append(b.el):d.children().eq(c).before(b.el)}})}),$(function(){ptc.start()});